// PPP

// SETUP du service
void setupPPP() {
  Serial.println("setup PPP");
  initMinitelService();
  wifiConnect();
  saisieColor = CARACTERE_NOIR;
  afficheSommairePPP();
  
}


// LOOP du service
void loopPPP() {
  Serial.println("loop PPP");
  while (1) {
    champVide(25, 12, 5);
  
    // Input
    wait_for_user_action();

    // Traitement de l'action utilisateur (maj des variables globales dans wait_for___)
    switch (touche) {

      // SI CONNEXION FIN on sort de la loop, on revient à la loop principale
      case CONNEXION_FIN:
        Serial.println("CONNEXION_FIN");
        return;
        break;

      // SI ENVOI on affiche la page du signe
      case ENVOI:
      {
        Serial.println("ENVOI " + userInput);
        if (userInputLength == 5) {
          retrieveDatasPPP();
          userInput = "";
          userInputLength = 0;
        }
      }
        break;

      case ANNULATION:
        champVide(25, 12, 5);
        break;

      case CORRECTION:
        {
          int nbCaracteres = userInput.length();
          if (nbCaracteres > 0) {
            minitel.moveCursorLeft(1);
            minitel.print(".");
            minitel.attributs(CARACTERE_BLANC);
            minitel.moveCursorLeft(1);
            userInput = userInput.substring(0, userInput.length() - 1);
            userInputLength--;
            Serial.println(userInput);
          }
        }
        break;
      case SOMMAIRE:
        {
          afficheSommairePPP();
          userInput = "";
          userInputLength = 0;
        }
        break;
    }
  }
}
// FIN LOOP

// Fonctions d'affichage et de traitement liées au service
void afficheSommairePPP() {
  currentEcran = "SOMMAIRE";
  minitel.newScreen();
  String vdt = "14,0c,1f,42,4a,0e,40,54,09,09,09,09,40,54,1f,43,4a,0e,4a,1b,57,20,09,09,09,09,1b,50,4a,1b,57,20,1f,44,4a,0e,4a,1b,57,20,09,09,09,09,1b,50,4a,1b,57,20,1f,45,4a,0e,4a,1b,57,20,09,09,09,09,1b,50,4a,1b,57,20,1f,46,4a,0e,4a,1b,57,20,09,09,09,09,1b,50,4a,1b,57,20,1f,47,4a,0e,4a,1b,57,20,1b,40,23,20,20,22,21,20,1f,48,4a,0e,1b,57,1b,40,21,20,20,20,20,20,20,20,1b,50,1b,47,34,1f,49,49,0e,40,1b,57,20,20,1b,40,30,20,20,20,30,20,2a,1f,4a,49,0e,4a,1b,57,20,20,1b,40,25,20,20,20,25,20,20,1f,4b,49,0e,4a,1b,57,20,12,42,1b,50,54,40,1b,57,1b,40,21,20,20,20,1f,4c,49,0e,1b,57,1b,40,21,20,20,20,20,20,20,20,20,20,1b,50,1b,47,34,1f,4d,49,0e,1b,57,20,12,49,1b,40,4a,1f,4e,49,0e,1b,57,20,12,49,1b,40,4a,1f,4f,48,0e,48,1b,57,20,12,49,1b,40,22,1f,50,48,0e,4a,1b,57,20,12,4a,1f,51,48,0e,4a,1b,57,20,12,4a,1f,52,48,0e,1b,57,1b,40,21,20,20,20,20,20,20,20,20,20,20,20,1b,50,1b,47,34,1f,53,41,0e,1b,54,20,12,46,1b,57,12,4c,1b,44,4a,1b,54,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,1f,54,41,0e,1b,54,20,12,46,1b,57,1b,44,30,20,20,20,20,20,20,20,20,20,20,20,1b,54,1b,47,25,20,12,53,1f,55,41,0e,1b,54,20,12,47,1b,43,23,1b,53,1b,44,50,30,20,20,20,20,20,50,58,1b,54,1b,43,21,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,1f,56,41,0e,1b,54,20,12,67,1f,57,41,0e,1b,54,20,12,67,1f,58,41,0e,1b,54,20,12,67,1f,45,58,1b,55,20,18,1f,46,58,1b,55,20,18,1f,47,58,1b,55,20,18,1f,48,58,1b,55,20,18,1f,49,58,1b,55,20,18,1f,4a,58,1b,55,20,18,1f,4b,58,1b,55,20,18,1f,4c,58,1b,55,20,18,1f,4d,58,1b,55,20,18,1f,46,59,50,6c,65,75,76,72,61,2d,74,2d,69,6c,20,1f,47,59,64,61,6e,73,20,6c,27,68,65,75,72,65,20,3f,1f,49,59,53,61,69,73,69,73,73,65,7a,20,76,6f,74,72,65,20,1f,4a,59,63,6f,64,65,20,70,6f,73,74,61,6c,1f,4c,59,1b,40,2e,12,44,20,1b,5d,20,45,4e,56,4f,49,20,1f,4c,59,11";
  checkScreen(vdt, 0, 0);
}
void afficheDatasPPP() {
  Serial.println(myObject);
  currentEcran= "PPP";
  JSONVar mode = myObject["root"]["precipitations"]["mode"];
  String pppmode = (const char*)mode;
  String vdt;
if (pppmode == "rain") {
    vdt = "14,1f,58,4b,1b,40,50,6c,75,69,65,20,6f,75,20,70,61,73,20,70,6c,75,69,65,20,3f,20,33,36,31,35,20,50,12,42,1f,42,42,1b,44,1b,4d,2f,20,20,2f,20,2f,2f,20,09,09,20,2f,2f,20,09,09,20,2f,20,2f,2f,20,12,43,2f,20,2f,20,2f,2f,20,12,43,2f,2f,20,2f,2f,20,2f,20,2f,2f,20,20,2f,09,09,09,2f,20,2f,09,09,09,2f,2f,20,20,2f,20,2f,20,12,42,2f,20,12,43,2f,20,20,2f,20,20,2f,20,2f,2f,20,20,2f,20,20,2f,09,09,09,2f,20,2f,09,09,09,2f,20,2f,20,20,2f,20,20,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,20,2f,20,2f,20,2f,20,2f,1f,48,53,1b,44,1b,4d,2f,20,20,2f,20,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,12,42,20,2f,1f,4a,54,1b,4d,1b,44,2f,20,20,2f,20,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,12,42,20,2f,1f,4c,55,1b,4d,1b,44,2f,20,20,2f,20,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,12,42,20,1f,4e,55,1b,4d,1b,44,2f,20,20,2f,20,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,2f,20,1f,50,55,1b,4d,1b,44,2f,20,20,2f,20,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,2f,20,2f,2f,20,1f,52,55,1b,4d,1b,44,2f,20,20,2f,20,20,2f,2f,20,2f,20,2f,2f,20,2f,20,2f,20,2f,1f,50,4a,0e,1b,57,1b,44,1b,48,40,54,1b,49,20,1b,48,40,54,1b,49,20,1b,48,40,54,1f,51,4a,0e,1b,57,1b,44,1b,48,22,27,1b,49,20,1b,48,22,27,1b,49,20,1b,48,22,27,1f,54,54,0e,1b,56,25,1b,54,1b,46,34,1f,55,4a,0e,1b,53,1b,46,50,30,09,09,09,09,09,50,58,1b,56,1b,43,21,20,1b,44,4a,09,09,09,09,09,1b,54,1b,46,50,1b,56,1b,44,23,21,20,12,42,1b,47,1b,5a,38,1b,44,1b,59,23,1b,54,1b,46,54,1f,56,4a,0e,1b,54,1b,46,23,1b,56,1b,44,50,50,20,12,44,1b,47,1b,5a,26,1b,44,1b,59,40,58,09,09,09,09,09,09,1b,54,1b,46,22,1b,56,1b,44,54,30,20,12,43,50,1b,54,1b,46,23,1f,57,4e,0e,1b,54,1b,46,23,12,43,21,1f,45,58,1b,55,20,18,1f,46,58,1b,55,20,18,1f,47,58,1b,55,20,18,1f,48,58,1b,55,20,18,1f,49,58,1b,55,20,18,1f,4a,58,1b,55,20,18,1f,4b,58,1b,55,20,18,1f,4c,58,1b,55,20,18,1f,4d,58,1b,55,20,18,1f,4a,5c,1b,4d,1b,40,49,4c,20,50,4c,45,55,54" ;
    }
  if (pppmode == "no") {
    vdt = "1f,41,41,0e,1b,56,20,12,59,1b,43,29,30,20,20,40,1b,53,1b,46,23,20,12,45,22,1b,56,1b,43,54,1f,42,41,0e,1b,56,20,12,48,40,54,20,12,43,40,54,20,12,49,1b,43,22,24,58,1b,53,20,12,49,1f,43,41,0e,1b,56,20,12,48,4a,09,20,12,43,4a,09,20,12,4a,1b,53,1b,46,25,20,12,4a,1f,44,41,0e,1b,56,20,12,48,4a,09,20,12,43,4a,09,20,12,49,1b,43,48,1b,53,20,12,4b,1f,45,41,0e,1b,56,20,12,48,4a,09,20,12,43,4a,09,20,12,49,1b,53,20,12,4c,1f,46,41,0e,1b,56,20,12,48,4a,09,20,12,43,4a,09,20,12,48,1b,43,4a,1b,53,20,12,4c,1f,47,41,0e,1b,56,20,12,48,4a,09,1b,57,1b,46,23,09,09,22,21,09,1b,56,20,20,1b,43,40,12,42,50,12,43,4a,1b,53,20,12,4c,1f,48,41,0e,1b,56,20,12,48,1b,57,1b,46,21,09,09,09,09,09,09,09,1b,56,1b,47,34,20,12,47,1b,43,4a,1b,53,20,12,4c,1f,49,41,0e,1b,56,20,12,47,40,09,09,09,09,09,09,09,09,1b,57,1b,46,2a,1b,56,20,12,47,1b,43,2a,1b,53,20,12,4c,1f,4a,41,0e,1b,56,20,12,47,4a,09,09,09,09,09,09,09,09,09,20,12,48,1b,53,1b,46,30,20,12,4b,1f,4b,41,0e,1b,56,20,12,47,4a,09,09,09,09,09,09,09,09,09,20,12,48,1b,43,22,1b,53,20,12,4b,1f,4c,41,0e,1b,56,20,12,47,1b,57,1b,46,21,09,09,09,09,09,09,09,09,09,1b,56,1b,47,34,20,12,48,1b,43,2a,1b,53,20,12,4a,1f,4d,41,0e,1b,56,20,12,47,1b,57,20,09,09,09,09,09,09,09,09,09,1b,46,4a,1b,56,20,12,47,1b,43,38,21,22,1b,53,1b,46,30,20,12,48,1f,4e,41,0e,1b,56,20,12,47,1b,57,20,09,09,09,09,09,09,09,09,09,1b,46,4a,1b,56,20,12,45,1b,43,40,26,20,12,43,23,1b,53,1b,46,50,30,20,12,42,50,58,1b,56,1b,43,21,1f,4f,41,0e,1b,56,20,12,46,48,1b,57,20,09,09,09,09,09,09,09,09,09,1b,46,22,1b,56,20,12,44,1b,43,38,21,20,12,48,34,20,12,43,1f,50,41,0e,1b,56,20,12,46,4a,09,09,1b,57,1b,43,30,09,09,30,09,09,30,09,09,1b,56,20,12,43,24,20,12,4a,1b,53,1b,46,4a,1b,56,20,12,43,1f,51,41,0e,1b,56,20,12,46,4a,09,1b,57,1b,43,22,1b,53,1b,47,58,09,1b,57,1b,43,22,1b,53,1b,47,58,09,1b,57,1b,43,22,1b,53,1b,47,58,09,09,1b,56,20,12,42,1b,43,21,20,12,4b,1b,53,1b,46,4a,1b,56,20,12,43,1f,52,41,0e,1b,56,20,12,46,1b,57,1b,46,21,09,09,09,09,09,09,09,09,09,09,09,1b,56,1b,47,34,20,12,4e,1b,43,31,20,12,43,1f,53,47,0e,1b,54,1b,40,40,1b,57,20,1f,54,47,0e,1b,44,21,1b,57,1b,40,30,1f,55,46,0e,1b,54,1b,40,48,1b,50,20,20,1b,43,23,1b,53,1b,40,50,50,1f,56,46,0e,1b,44,21,20,12,46,40,58,1b,54,1b,40,23,1f,57,45,0e,1b,54,1b,40,38,23,1b,50,1b,44,30,20,12,42,50,58,1b,54,1b,40,21,1f,58,46,0e,1b,54,1b,40,40,26,23,21,1f,45,58,1b,55,20,18,1f,46,58,1b,55,20,18,1f,47,58,1b,55,20,18,1f,48,58,1b,55,20,18,1f,49,58,1b,55,20,18,1f,4a,58,1b,55,20,18,1f,4b,58,1b,55,20,18,1f,4c,58,1b,55,20,18,1f,4d,58,1b,55,20,18,1f,4a,59,1b,4d,1b,40,49,4c,20,4e,45,20,50,4c,45,55,54,20,50,41,53";
    }
 if (pppmode == "snow") {
    vdt = "14,1f,41,41,0e,20,12,67,1f,42,41,0e,20,12,48,40,54,20,12,43,40,54,20,12,56,1f,43,41,0e,20,12,48,4a,09,20,12,43,4a,09,20,12,56,1f,44,41,0e,20,12,48,4a,09,20,12,43,4a,09,20,12,56,1f,45,41,0e,20,12,48,4a,09,20,12,43,4a,09,20,12,56,1f,46,41,0e,20,12,48,4a,09,20,12,43,4a,09,20,12,56,1f,47,41,0e,20,12,48,4a,09,1b,57,1b,40,23,09,09,22,21,09,1b,50,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,1f,48,41,0e,20,12,48,1b,57,1b,40,21,09,09,09,09,09,09,09,1b,50,1b,47,34,20,12,55,1f,49,41,0e,20,12,47,40,09,09,09,09,09,09,09,09,1b,57,1b,40,2a,1b,50,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,1f,4a,41,0e,20,12,47,4a,09,09,09,09,09,09,09,09,09,20,12,55,1f,4b,41,0e,20,12,47,4a,09,09,09,09,09,09,09,09,09,20,12,55,1f,4c,41,0e,20,12,47,1b,57,1b,40,21,09,09,09,09,09,09,09,09,09,1b,50,1b,47,34,20,12,54,1f,4d,41,0e,20,12,47,1b,57,20,09,09,09,09,09,09,09,09,09,1b,40,4a,1b,50,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,1f,4e,41,0e,20,12,47,1b,57,20,09,09,09,09,09,09,09,09,09,1b,40,4a,1b,50,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,1f,4f,41,0e,20,12,46,48,1b,57,20,09,09,09,09,09,09,09,09,09,1b,40,22,1b,50,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,1f,50,41,0e,20,12,46,4a,09,09,09,09,09,1b,57,1b,44,1b,48,30,09,09,09,09,09,1b,50,1b,49,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,1f,51,41,0e,20,12,46,4a,09,09,09,09,1b,57,1b,44,1b,48,22,27,09,09,09,09,09,1b,50,1b,49,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,1f,52,41,0e,20,12,46,1b,57,1b,40,21,09,09,09,09,09,09,09,09,09,09,09,1b,50,1b,47,34,20,12,53,1f,41,67,0e,30,1f,42,5a,0e,22,1b,57,1b,40,31,1b,50,1b,47,26,09,09,09,28,09,09,09,09,22,09,09,30,1f,43,43,0e,21,09,09,09,24,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,28,1b,57,1b,40,45,09,1b,50,1b,47,4a,09,2a,38,09,09,09,21,09,09,24,1f,44,57,0e,40,23,22,44,4a,40,26,22,41,1f,45,56,0e,40,28,1b,57,1b,40,42,1b,50,1b,47,2c,2c,1b,57,1b,40,28,42,1b,50,1b,47,2c,2c,1b,57,1b,40,42,1f,46,44,0e,30,44,24,30,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,22,50,40,26,4a,22,44,40,32,1f,47,43,0e,28,32,38,32,38,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,28,49,09,4a,09,48,29,09,09,09,09,09,09,22,1f,48,43,0e,22,38,42,28,32,09,09,09,09,09,09,09,09,09,09,09,09,09,21,09,09,09,09,40,1b,57,1b,40,31,1b,50,1b,47,44,1f,49,41,0e,28,09,09,09,21,21,1f,4b,59,0e,22,09,09,09,09,09,09,21,1f,4c,5a,0e,30,1f,4d,44,0e,24,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,24,1f,4e,46,0e,22,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,40,09,09,09,09,09,09,09,09,09,40,1f,4f,43,0e,40,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,30,09,09,09,09,09,09,28,1f,50,59,0e,21,09,09,40,09,09,09,09,09,09,21,1f,51,44,0e,24,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,40,09,21,1f,52,59,0e,40,50,12,43,58,1b,57,1b,40,23,1b,50,1b,47,54,50,12,42,30,09,09,21,1f,53,41,0e,1b,57,1b,44,50,12,42,58,1b,54,1b,47,23,21,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,22,1b,57,1b,44,50,30,20,20,20,20,20,20,20,20,20,20,40,50,50,58,1b,54,1b,47,23,1f,54,44,0e,1b,54,30,28,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,40,09,09,22,1b,57,1b,44,50,12,45,1b,54,1b,47,23,23,1f,55,46,0e,1b,54,24,21,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,09,28,1f,56,59,0e,1b,54,40,1f,57,4e,0e,1b,54,38,09,41,09,40,40,09,09,09,28,1f,45,58,1b,55,20,18,1f,46,58,1b,55,20,18,1f,47,58,1b,55,20,18,1f,48,58,1b,55,20,18,1f,49,58,1b,55,20,18,1f,4a,58,1b,55,20,18,1f,4b,58,1b,55,20,18,1f,4c,58,1b,55,18,1f,49,5b,1b,4d,1b,40,49,4c,20,4e,45,49,47,45,20,21,1f,42,59";
 }
  checkScreen(vdt, 0, 0);
  minitel.newXY(25,6);
  JSONVar date = myObject["root"]["date"];
  minitel.attributs(CARACTERE_BLANC);
  minitel.print((const char*)date);
  minitel.newXY(25,7);
  JSONVar heure = myObject["root"]["heure"];
  minitel.attributs(CARACTERE_BLANC);
  minitel.print((const char*)heure);
}
void retrieveDatasPPP() {
  Serial.println("PPPPPPRETRIEVE");
  Serial.println(userInput);
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    String serverPath = serverName + String("ppp/getjson.php?cp=") + userInput;
    Serial.println(serverPath);
    // Your Domain name with URL path or IP address with path
    http.begin(serverPath.c_str());
    int httpResponseCode = http.GET();
    if (httpResponseCode > 0) {
      String payload = http.getString();
      myObject = JSON.parse(payload);
      if (JSON.typeof(myObject) == "undefined") {
        Serial.println("Parsing input failed!");
        return;
      }
      afficheDatasPPP();
    }
    // Free resources
    http.end();
  } else {
    Serial.println("WiFi Disconnected");
  }
}